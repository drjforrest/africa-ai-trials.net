#!/bin/bash
# Cleanup malware from african-ai-trials production server

set -e

REMOTE_USER="jforrest"
REMOTE_HOST="192.168.1.69"
PROJECT_DIR="/Users/jforrest/production/african-ai-trials"

echo "ğŸ§¹ Starting malware cleanup on production server"
echo "Target: $REMOTE_USER@$REMOTE_HOST:$PROJECT_DIR"
echo ""
echo "âš ï¸  WARNING: This will:"
echo "  1. Stop the running application"
echo "  2. Remove all malicious files"
echo "  3. Delete node_modules and package-lock.json"
echo "  4. Reinstall dependencies safely"
echo ""
read -p "Continue? (yes/no): " confirm

if [ "$confirm" != "yes" ]; then
    echo "Aborted."
    exit 1
fi

echo ""
echo "ğŸ”´ Step 1: Stopping application and malicious processes..."

ssh -T -o Ciphers=aes256-gcm@openssh.com $REMOTE_USER@$REMOTE_HOST << 'EOF'
cd /Users/jforrest/production/african-ai-trials

# Stop the application
echo "Stopping Next.js application..."
lsof -ti:3030 | xargs kill -9 2>/dev/null || true

# Kill any suspicious processes
echo "Killing suspicious processes..."
pkill -9 -f "xmrig" 2>/dev/null || true
pkill -9 -f "mine" 2>/dev/null || true
pkill -9 -f "linuxsys" 2>/dev/null || true
pkill -9 -f "syssls" 2>/dev/null || true

# Wait for processes to die
sleep 2

echo "âœ… Processes stopped"
EOF

echo ""
echo "ğŸ—‘ï¸  Step 2: Removing malicious files..."

ssh -T -o Ciphers=aes256-gcm@openssh.com $REMOTE_USER@$REMOTE_HOST << 'EOF'
cd /Users/jforrest/production/african-ai-trials

# Remove known malware files
echo "Removing malware files..."
rm -f mine r.sh r_clean.sh 2>/dev/null || true
rm -rf xmrig-6.24.0 2>/dev/null || true

# Check for and remove other suspicious files
find . -maxdepth 1 -name "*.sh" -type f -exec grep -l "xmrig\|repositorylinux\|linuxsys" {} \; -delete 2>/dev/null || true

# Remove temporary malware artifacts
rm -f /tmp/powerlog /tmp/linuxsys /tmp/syssls 2>/dev/null || true

echo "âœ… Malware files removed"
EOF

echo ""
echo "ğŸ§¼ Step 3: Cleaning npm packages..."

ssh -T -o Ciphers=aes256-gcm@openssh.com $REMOTE_USER@$REMOTE_HOST << 'EOF'
cd /Users/jforrest/production/african-ai-trials

# Set up Node.js environment
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
export PATH="$HOME/.nvm/versions/node/v22.21.1/bin:$PATH"

# Remove node_modules and lockfile
echo "Removing node_modules and package-lock.json..."
rm -rf node_modules package-lock.json .next

echo "âœ… npm artifacts cleaned"
EOF

echo ""
echo "ğŸ“¦ Step 4: Reinstalling dependencies safely..."

ssh -T -o Ciphers=aes256-gcm@openssh.com $REMOTE_USER@$REMOTE_HOST << 'EOF'
cd /Users/jforrest/production/african-ai-trials

# Set up Node.js environment
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
export PATH="$HOME/.nvm/versions/node/v22.21.1/bin:$PATH"

# Install with --ignore-scripts to prevent malicious postinstall
echo "Running npm install --ignore-scripts..."
npm install --ignore-scripts

# Manually allow safe postinstall scripts
echo "Running safe postinstall scripts..."
# better-sqlite3 needs to build native bindings
cd node_modules/better-sqlite3 && npm run install 2>/dev/null || true
cd ../..

# Tailwind needs platform binaries
cd node_modules/@tailwindcss/oxide && node scripts/install.js 2>/dev/null || true
cd ../..

echo "âœ… Dependencies reinstalled safely"
EOF

echo ""
echo "ğŸ”¨ Step 5: Building application..."

ssh -T -o Ciphers=aes256-gcm@openssh.com $REMOTE_USER@$REMOTE_HOST << 'EOF'
cd /Users/jforrest/production/african-ai-trials

# Set up Node.js environment
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
export PATH="$HOME/.nvm/versions/node/v22.21.1/bin:$PATH"

export NODE_ENV=production
npm run build

echo "âœ… Build complete"
EOF

echo ""
echo "ğŸ” Step 6: Security audit..."

ssh -T -o Ciphers=aes256-gcm@openssh.com $REMOTE_USER@$REMOTE_HOST << 'EOF'
cd /Users/jforrest/production/african-ai-trials

# Set up Node.js environment
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
export PATH="$HOME/.nvm/versions/node/v22.21.1/bin:$PATH"

echo "Running npm audit..."
npm audit --omit=dev || true

echo ""
echo "Checking for suspicious files..."
find . -maxdepth 2 -type f \( -name "*.sh" -o -name "mine" -o -name "*xmrig*" \) 2>/dev/null || true

echo "âœ… Audit complete"
EOF

echo ""
echo "ğŸš€ Step 7: Restarting application..."

ssh -T -o Ciphers=aes256-gcm@openssh.com $REMOTE_USER@$REMOTE_HOST << 'EOF'
cd /Users/jforrest/production/african-ai-trials

# Set up Node.js environment
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
export PATH="$HOME/.nvm/versions/node/v22.21.1/bin:$PATH"

# Create logs directory
mkdir -p logs

# Reload LaunchAgent
launchctl unload ~/Library/LaunchAgents/com.african-ai-trials.plist 2>/dev/null || true
launchctl load ~/Library/LaunchAgents/com.african-ai-trials.plist

# Wait for startup
sleep 10

# Check health
echo ""
echo "ğŸ” Health check:"
lsof -i :3030 && echo "âœ… Port 3030 is listening" || echo "âŒ Port 3030 not listening"
curl -sf http://localhost:3030 > /dev/null && echo "âœ… Application responding" || echo "âŒ Application not responding"

EOF

echo ""
echo "âœ… Cleanup complete!"
echo ""
echo "ğŸ“‹ Summary:"
echo "  âœ… Malicious files removed"
echo "  âœ… Dependencies reinstalled safely"
echo "  âœ… Application rebuilt"
echo "  âœ… Service restarted"
echo ""
echo "ğŸ” Next steps:"
echo "  1. Monitor logs for any suspicious activity"
echo "  2. Review package.json for unknown dependencies"
echo "  3. Update deploy script to use --ignore-scripts"
echo "  4. Consider implementing package integrity checks"
echo ""
echo "ğŸ“Š Monitor with:"
echo "  tail -f $PROJECT_DIR/logs/app.log"
